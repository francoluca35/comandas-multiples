# Sistema de Roles y Permisos - Restaurante App

## DescripciÃ³n General

Este sistema implementa un control de acceso basado en roles (RBAC) para la aplicaciÃ³n de restaurante, permitiendo que diferentes tipos de usuarios accedan solo a las funcionalidades que les corresponden segÃºn su rol asignado.

## Roles Disponibles

### ğŸ”´ ADMIN
- **Acceso total** sin restricciones
- Puede gestionar todos los mÃ³dulos del sistema
- Control completo sobre usuarios, productos, inventario, pagos, etc.

### ğŸ”µ MESERO
- **Dashboard** (`home`) - Acceso al panel principal
- **Turno** - Puede abrir y cerrar su turno
- **Ventas** - Acceso al mÃ³dulo de ventas
- **Sin acceso** a gestiÃ³n administrativa

### ğŸŸ¢ COCINA
- **Dashboard** (`home`) - Acceso al panel principal  
- **Turno** - Puede abrir y cerrar su turno
- **Ventas** - Acceso al mÃ³dulo de ventas
- **Sin acceso** a gestiÃ³n administrativa

## Permisos del Sistema

### Permisos de NavegaciÃ³n
- `canAccessHome` - Acceso al dashboard principal
- `canAccessVentas` - Acceso al mÃ³dulo de ventas
- `canAccessMesas` - GestiÃ³n de mesas
- `canAccessProductos` - GestiÃ³n de productos
- `canAccessPagos` - GestiÃ³n de pagos e ingresos
- `canAccessInventario` - Control de inventario
- `canAccessReportes` - Reportes y estadÃ­sticas
- `canAccessPromociones` - GestiÃ³n de promociones

### Permisos de GestiÃ³n
- `canManageTurno` - Abrir/cerrar turno (todos los roles)
- `canManageUsers` - GestiÃ³n de usuarios
- `canManageRestaurant` - ConfiguraciÃ³n del restaurante
- `canViewAllData` - Acceso a todos los datos

## ImplementaciÃ³n TÃ©cnica

### 1. Contexto de Roles (`RoleContext`)
```javascript
// src/app/context/RoleContext.js
const RoleContext = createContext();

export const RoleProvider = ({ children }) => {
  const { usuario, rol } = useAuth();
  
  const permissions = useMemo(() => {
    // LÃ³gica de permisos basada en el rol
  }, [rol]);
  
  // ... resto de la implementaciÃ³n
};
```

### 2. Hook de Permisos (`useRolePermissions`)
```javascript
// src/hooks/useRolePermissions.js
export const useRolePermissions = () => {
  const { permissions, roleInfo, currentRole } = useRole();
  
  const canAccess = (permission) => {
    return permissions?.[permission] || false;
  };
  
  // ... helpers adicionales
};
```

### 3. ProtecciÃ³n de Rutas (`RoleGuard`)
```javascript
// src/components/RoleGuard.jsx
const RoleGuard = ({ 
  children, 
  requiredPermission, 
  fallback, 
  redirectTo 
}) => {
  // VerificaciÃ³n de permisos y redirecciÃ³n
};
```

### 4. Sidebar DinÃ¡mico
El sidebar se adapta automÃ¡ticamente mostrando solo las opciones disponibles para el rol del usuario:

```javascript
// src/app/home-comandas/home/components/Sidebar.jsx
{permissions.canAccessHome && (
  <div className={getItemClasses("home")}>
    {/* OpciÃ³n de Home */}
  </div>
)}
```

## Uso del Sistema

### ProtecciÃ³n de PÃ¡ginas
```javascript
import RoleGuard from "../../../components/RoleGuard";

const ProductosPage = () => {
  return (
    <RestaurantGuard>
      <RoleGuard 
        requiredPermission="canAccessProductos"
        fallback={<AccesoDenegado />}
      >
        {/* Contenido de la pÃ¡gina */}
      </RoleGuard>
    </RestaurantGuard>
  );
};
```

### VerificaciÃ³n de Permisos en Componentes
```javascript
import { useRolePermissions } from "../../../../hooks/useRolePermissions";

const MiComponente = () => {
  const { canAccess, isAdmin, currentRole } = useRolePermissions();
  
  if (!canAccess("canAccessVentas")) {
    return <p>No tienes permisos para ver ventas</p>;
  }
  
  return <div>Contenido de ventas</div>;
};
```

### VerificaciÃ³n Condicional
```javascript
const { canAccessMultiple, canAccessAny } = useRolePermissions();

// Verificar mÃºltiples permisos
if (canAccessMultiple(["canAccessVentas", "canAccessHome"])) {
  // Usuario tiene ambos permisos
}

// Verificar al menos un permiso
if (canAccessAny(["canAccessProductos", "canAccessInventario"])) {
  // Usuario tiene al menos uno de los permisos
}
```

## Funcionalidades Especiales

### Cierre AutomÃ¡tico de Turno
- **Al cerrar sesiÃ³n**: El sistema automÃ¡ticamente cierra el turno activo
- **ImplementaciÃ³n**: Se ejecuta `cerrarTurno()` antes de limpiar la sesiÃ³n
- **UbicaciÃ³n**: `src/app/home-comandas/home/components/Sidebar.jsx`

```javascript
const handleLogout = async () => {
  // Cerrar turno antes de cerrar sesiÃ³n
  try {
    await cerrarTurno();
  } catch (error) {
    console.log("Error al cerrar turno:", error);
  }
  
  // Limpiar sesiÃ³n y redirigir
  // ...
};
```

### GestiÃ³n de Turnos
- **Todos los roles** pueden abrir y cerrar turnos
- **Persistencia**: Los turnos se guardan en localStorage
- **ValidaciÃ³n**: Los turnos se cierran automÃ¡ticamente despuÃ©s de 24 horas

## ConfiguraciÃ³n

### 1. Agregar RoleProvider
```javascript
// src/providers/AppProvider.jsx
import { RoleProvider } from "../app/context/RoleContext";

export const AppProvider = ({ children }) => {
  return (
    <QueryProvider>
      <GlobalErrorHandler>
        <AuthHandler>
          <RoleProvider>
            <TurnoProvider>
              {children}
            </TurnoProvider>
          </RoleProvider>
        </AuthHandler>
      </GlobalErrorHandler>
    </QueryProvider>
  );
};
```

### 2. Asignar Roles a Usuarios
Los roles se asignan a travÃ©s del `AuthContext`:
- **Superadmin**: Usa Firebase Auth
- **Restaurante**: Usa localStorage con campo `rol`

### 3. Personalizar Permisos
Para modificar los permisos, edita `src/app/context/RoleContext.js`:

```javascript
case "mesero":
  return {
    ...basePermissions,
    canAccessHome: true,
    canAccessVentas: true,
    // Agregar o quitar permisos segÃºn necesidad
  };
```

## PÃ¡ginas Protegidas

Las siguientes pÃ¡ginas estÃ¡n protegidas con `RoleGuard`:

- **Productos** (`canAccessProductos`) - Solo ADMIN
- **Inventario** (`canAccessInventario`) - Solo ADMIN  
- **Pagos** (`canAccessPagos`) - Solo ADMIN
- **Mesas** (`canAccessMesas`) - Solo ADMIN
- **Reportes** (`canAccessReportes`) - Solo ADMIN

## Componentes de UI

### RoleInfoCard
Muestra informaciÃ³n del rol del usuario en el dashboard:
- Nombre del rol
- DescripciÃ³n
- Permisos activos
- Colores personalizados por rol

### Indicador de Rol en Sidebar
Cuando el sidebar estÃ¡ expandido, muestra:
- Nombre del rol
- DescripciÃ³n
- Colores distintivos por tipo de rol

## Estructura de Archivos

```
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ context/
â”‚   â”‚   â”œâ”€â”€ RoleContext.js          # Contexto de roles y permisos
â”‚   â”‚   â”œâ”€â”€ AuthContext.js          # AutenticaciÃ³n existente
â”‚   â”‚   â””â”€â”€ TurnoContext.js         # GestiÃ³n de turnos
â”‚   â””â”€â”€ home-comandas/
â”‚       â”œâ”€â”€ home/
â”‚       â”‚   â”œâ”€â”€ components/
â”‚       â”‚   â”‚   â”œâ”€â”€ Sidebar.jsx     # Sidebar con permisos
â”‚       â”‚   â”‚   â””â”€â”€ RoleInfoCard.jsx # Info del rol
â”‚       â”‚   â””â”€â”€ page.jsx            # Dashboard con info de rol
â”‚       â””â”€â”€ [otras pÃ¡ginas protegidas]
â”œâ”€â”€ components/
â”‚   â””â”€â”€ RoleGuard.jsx               # ProtecciÃ³n de rutas
â”œâ”€â”€ hooks/
â”‚   â””â”€â”€ useRolePermissions.js       # Hook de permisos
â””â”€â”€ providers/
    â””â”€â”€ AppProvider.jsx             # Provider principal
```

## Beneficios del Sistema

1. **Seguridad**: Acceso controlado basado en roles
2. **UX Mejorada**: Solo se muestran opciones relevantes
3. **Mantenibilidad**: Permisos centralizados y fÃ¡ciles de modificar
4. **Escalabilidad**: FÃ¡cil agregar nuevos roles y permisos
5. **AuditorÃ­a**: Control de acceso granular y trazable

## PrÃ³ximos Pasos

- [ ] Implementar permisos mÃ¡s granulares por acciÃ³n
- [ ] Agregar logging de accesos y cambios
- [ ] Crear panel de administraciÃ³n de roles
- [ ] Implementar permisos temporales
- [ ] Agregar validaciÃ³n de permisos en el backend

---

# IntegraciÃ³n de Mercado Pago (Modelo Individual por Restaurante)

## Arquitectura Multi-Tenant

Esta aplicaciÃ³n utiliza un **modelo individual** donde cada restaurante conecta su propia cuenta de Mercado Pago:

- **Cuentas individuales**: Cada restaurante tiene su propia cuenta de Mercado Pago
- **ConfiguraciÃ³n inicial**: Los restaurantes configuran sus credenciales durante el primer acceso
- **Sin comisiones**: Los restaurantes reciben el 100% de sus pagos
- **Control total**: Cada restaurante maneja sus propios pagos y fondos

## ConfiguraciÃ³n

### Variables de Entorno
```env
# Solo necesitas configurar la URL base
NEXT_PUBLIC_BASE_URL=https://tu-dominio.com

# Firebase (ya configurado)
FIREBASE_API_KEY=xxx
FIREBASE_AUTH_DOMAIN=xxx
FIREBASE_PROJECT_ID=xxx
```

### ConfiguraciÃ³n de Mercado Pago
**No necesitas configurar Mercado Pago globalmente.** Cada restaurante configura sus propias credenciales:

1. **Los restaurantes crean su cuenta** en Mercado Pago Developers
2. **Obtienen sus credenciales** (Access Token y Public Key)
3. **Las configuran en la app** durante el primer acceso
4. **Los webhooks se configuran automÃ¡ticamente**

## Flujo de Pago

### 1. Inicio del Pago
```javascript
// En CobranzaModal.jsx
const result = await processPayment(orderData, 'tarjeta');
// Redirige automÃ¡ticamente a Mercado Pago
```

### 2. Procesamiento en Mercado Pago
- Cliente completa el pago en Mercado Pago
- Se procesa con tarjeta de crÃ©dito/dÃ©bito
- Mercado Pago notifica el resultado

### 3. Webhook y Procesamiento
```javascript
// En /api/pagos/webhook/route.js
case 'approved':
  const restaurantAmount = orderTotal; // 100% para el restaurante
  // Procesar pago con credenciales del restaurante
```

### 4. ConfirmaciÃ³n
- Cliente regresa a la aplicaciÃ³n
- Se muestra confirmaciÃ³n de pago
- Mesa se marca como "pagada"

## Funcionalidades Implementadas

### âœ… Pagos con Tarjeta
- IntegraciÃ³n completa con Mercado Pago
- Soporte para tarjetas de crÃ©dito y dÃ©bito
- Procesamiento en tiempo real

### âœ… ConfiguraciÃ³n Individual
- Cada restaurante configura sus propias credenciales
- ConfiguraciÃ³n guiada durante el primer acceso
- ValidaciÃ³n automÃ¡tica de credenciales

### âœ… Historial de Pagos
- Vista de todas las transacciones del restaurante
- EstadÃ­sticas de pagos aprobados/rechazados
- Filtros por perÃ­odo

### âœ… Webhooks
- Notificaciones automÃ¡ticas de Mercado Pago
- Procesamiento de estados: approved, pending, rejected, cancelled
- ActualizaciÃ³n automÃ¡tica de mesas

## Archivos Principales

```
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ pagos/
â”‚   â”‚       â”œâ”€â”€ route.js              # Crear preferencias de pago
â”‚   â”‚       â”œâ”€â”€ webhook/route.js      # Procesar notificaciones
â”‚   â”‚       â””â”€â”€ history/route.js      # Historial de pagos
â”‚   â””â”€â”€ home-comandas/
â”‚       â”œâ”€â”€ configuracion/
â”‚       â”‚   â””â”€â”€ page.jsx              # PÃ¡gina de configuraciÃ³n inicial
â”‚       â””â”€â”€ pagos/
â”‚           â””â”€â”€ components/
â”‚               â””â”€â”€ PaymentHistory.jsx # Vista de historial
â”œâ”€â”€ hooks/
â”‚   â””â”€â”€ usePaymentProcessor.js        # LÃ³gica de pagos
â””â”€â”€ components/
    â””â”€â”€ PaymentStatusModal.jsx        # Modal de estado
```

## Seguridad

- **ValidaciÃ³n de webhooks**: VerificaciÃ³n de origen de Mercado Pago
- **EncriptaciÃ³n**: Credenciales almacenadas en Firestore de forma segura
- **AuditorÃ­a**: Registro completo de transacciones por restaurante
- **Aislamiento**: Cada restaurante ve solo sus datos y usa sus propias credenciales

## Soporte

### Modo de Prueba (Sandbox)
```javascript
// Tarjetas de prueba
Visa: 4509 9535 6623 3704
Mastercard: 5031 4332 1540 6351
// Fecha: cualquier fecha futura
// CVV: 123
```

### Estados de Pago
- **approved**: Pago exitoso, mesa marcada como pagada
- **pending**: Pago en proceso, mesa permanece ocupada
- **rejected**: Pago rechazado, mesa permanece ocupada
- **cancelled**: Pago cancelado, mesa permanece ocupada

## Arquitectura de Dominio Ãšnico

### CaracterÃ­sticas del Sistema
- **Un solo dominio**: Todos los restaurantes acceden desde la misma URL
- **Sesiones individuales**: Cada restaurante tiene su propia sesiÃ³n y configuraciÃ³n
- **Aislamiento de datos**: Cada restaurante ve solo sus propios datos
- **ConfiguraciÃ³n independiente**: Cada restaurante configura su propio Mercado Pago

### Flujo de ConfiguraciÃ³n para Nuevos Restaurantes

### 1. ActivaciÃ³n desde Home Master
- El administrador crea la cuenta del restaurante
- Se genera un cÃ³digo de activaciÃ³n
- El restaurante recibe acceso con email y contraseÃ±a

### 2. Primer Acceso
- El restaurante accede al **mismo dominio** que todos los demÃ¡s
- Inicia sesiÃ³n con sus credenciales Ãºnicas
- **RedirecciÃ³n automÃ¡tica** a la pÃ¡gina de configuraciÃ³n
- Sistema detecta que es un usuario nuevo

### 3. ConfiguraciÃ³n de Mercado Pago
- **GuÃ­a paso a paso** para crear cuenta en Mercado Pago Developers
- **Campos para Access Token y Public Key**
- **ValidaciÃ³n automÃ¡tica** de credenciales
- **ConfiguraciÃ³n de informaciÃ³n del restaurante**

### 4. Completar ConfiguraciÃ³n
- Una vez configurado Mercado Pago, se marca como "configuraciÃ³n completada"
- **RedirecciÃ³n automÃ¡tica** al dashboard principal
- El restaurante puede comenzar a usar la aplicaciÃ³n

### 5. Acceso Normal
- En accesos posteriores, va directamente al dashboard
- Puede acceder a configuraciÃ³n desde el sidebar para modificar datos
- **Mantiene su sesiÃ³n individual** en el dominio compartido

## Ventajas del Dominio Ãšnico

### âœ… **Escalabilidad**
- Un solo dominio para todos los restaurantes
- FÃ¡cil mantenimiento y actualizaciones
- Recursos compartidos optimizados

### âœ… **Experiencia de Usuario**
- URL simple y memorable
- No confusiÃ³n con mÃºltiples dominios
- Acceso directo sin recordar URLs especÃ­ficas

### âœ… **GestiÃ³n Centralizada**
- Un solo punto de control
- Actualizaciones automÃ¡ticas para todos
- Monitoreo centralizado

### âœ… **Costos Reducidos**
- Un solo dominio y hosting
- Menos certificados SSL
- Menor complejidad de infraestructura

### âœ… **Seguridad**
- Aislamiento de datos por restaurante
- Sesiones individuales seguras
- Credenciales independientes de Mercado Pago

## Ejemplo de Flujo Completo

### Escenario: 3 Restaurantes en el Mismo Dominio

```
Dominio: https://comandas-app.com

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    COMANDAS APP                             â”‚
â”‚              (Dominio Ãšnico)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Restaurante A: https://comandas-app.com
â”œâ”€â”€ Usuario: restauranteA@email.com
â”œâ”€â”€ ConfiguraciÃ³n: Mercado Pago A
â””â”€â”€ Datos: Solo ve sus mesas, pedidos, pagos

Restaurante B: https://comandas-app.com  
â”œâ”€â”€ Usuario: restauranteB@email.com
â”œâ”€â”€ ConfiguraciÃ³n: Mercado Pago B
â””â”€â”€ Datos: Solo ve sus mesas, pedidos, pagos

Restaurante C: https://comandas-app.com
â”œâ”€â”€ Usuario: restauranteC@email.com
â”œâ”€â”€ ConfiguraciÃ³n: Mercado Pago C
â””â”€â”€ Datos: Solo ve sus mesas, pedidos, pagos
```

### Flujo de Acceso:
1. **Restaurante A** accede a `https://comandas-app.com`
2. **Inicia sesiÃ³n** con `restauranteA@email.com`
3. **Sistema detecta** que es su primera vez
4. **Redirige a configuraciÃ³n** para conectar Mercado Pago
5. **Completa configuraciÃ³n** y va al dashboard
6. **Ve solo sus datos** (mesas, pedidos, pagos)

### Aislamiento de Datos:
- **Restaurante A** nunca ve datos de B o C
- **Cada uno** tiene su propia configuraciÃ³n de Mercado Pago
- **Sesiones independientes** en el mismo dominio
- **Credenciales Ãºnicas** para cada restaurante

## ProducciÃ³n

### Checklist de ProducciÃ³n
- [ ] Configurar URL base de producciÃ³n
- [ ] Verificar configuraciÃ³n de seguridad
- [ ] Probar configuraciÃ³n de restaurantes
- [ ] Configurar alertas de transacciones

### Monitoreo
- Revisar logs de webhooks regularmente
- Monitorear tasa de aprobaciÃ³n de pagos por restaurante
- Verificar configuraciÃ³n de credenciales
- Alertas para transacciones fallidas
