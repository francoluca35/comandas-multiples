# Sistema de Roles y Permisos - Restaurante App

## DescripciÃ³n General

Este sistema implementa un control de acceso basado en roles (RBAC) para la aplicaciÃ³n de restaurante, permitiendo que diferentes tipos de usuarios accedan solo a las funcionalidades que les corresponden segÃºn su rol asignado.

## Roles Disponibles

### ðŸ”´ ADMIN
- **Acceso total** sin restricciones
- Puede gestionar todos los mÃ³dulos del sistema
- Control completo sobre usuarios, productos, inventario, pagos, etc.

### ðŸ”µ MESERO
- **Dashboard** (`home`) - Acceso al panel principal
- **Turno** - Puede abrir y cerrar su turno
- **Ventas** - Acceso al mÃ³dulo de ventas
- **Sin acceso** a gestiÃ³n administrativa

### ðŸŸ¢ COCINA
- **Dashboard** (`home`) - Acceso al panel principal  
- **Turno** - Puede abrir y cerrar su turno
- **Ventas** - Acceso al mÃ³dulo de ventas
- **Sin acceso** a gestiÃ³n administrativa

## Permisos del Sistema

### Permisos de NavegaciÃ³n
- `canAccessHome` - Acceso al dashboard principal
- `canAccessVentas` - Acceso al mÃ³dulo de ventas
- `canAccessMesas` - GestiÃ³n de mesas
- `canAccessProductos` - GestiÃ³n de productos
- `canAccessPagos` - GestiÃ³n de pagos e ingresos
- `canAccessInventario` - Control de inventario
- `canAccessReportes` - Reportes y estadÃ­sticas
- `canAccessPromociones` - GestiÃ³n de promociones

### Permisos de GestiÃ³n
- `canManageTurno` - Abrir/cerrar turno (todos los roles)
- `canManageUsers` - GestiÃ³n de usuarios
- `canManageRestaurant` - ConfiguraciÃ³n del restaurante
- `canViewAllData` - Acceso a todos los datos

## ImplementaciÃ³n TÃ©cnica

### 1. Contexto de Roles (`RoleContext`)
```javascript
// src/app/context/RoleContext.js
const RoleContext = createContext();

export const RoleProvider = ({ children }) => {
  const { usuario, rol } = useAuth();
  
  const permissions = useMemo(() => {
    // LÃ³gica de permisos basada en el rol
  }, [rol]);
  
  // ... resto de la implementaciÃ³n
};
```

### 2. Hook de Permisos (`useRolePermissions`)
```javascript
// src/hooks/useRolePermissions.js
export const useRolePermissions = () => {
  const { permissions, roleInfo, currentRole } = useRole();
  
  const canAccess = (permission) => {
    return permissions?.[permission] || false;
  };
  
  // ... helpers adicionales
};
```

### 3. ProtecciÃ³n de Rutas (`RoleGuard`)
```javascript
// src/components/RoleGuard.jsx
const RoleGuard = ({ 
  children, 
  requiredPermission, 
  fallback, 
  redirectTo 
}) => {
  // VerificaciÃ³n de permisos y redirecciÃ³n
};
```

### 4. Sidebar DinÃ¡mico
El sidebar se adapta automÃ¡ticamente mostrando solo las opciones disponibles para el rol del usuario:

```javascript
// src/app/home-comandas/home/components/Sidebar.jsx
{permissions.canAccessHome && (
  <div className={getItemClasses("home")}>
    {/* OpciÃ³n de Home */}
  </div>
)}
```

## Uso del Sistema

### ProtecciÃ³n de PÃ¡ginas
```javascript
import RoleGuard from "../../../components/RoleGuard";

const ProductosPage = () => {
  return (
    <RestaurantGuard>
      <RoleGuard 
        requiredPermission="canAccessProductos"
        fallback={<AccesoDenegado />}
      >
        {/* Contenido de la pÃ¡gina */}
      </RoleGuard>
    </RestaurantGuard>
  );
};
```

### VerificaciÃ³n de Permisos en Componentes
```javascript
import { useRolePermissions } from "../../../../hooks/useRolePermissions";

const MiComponente = () => {
  const { canAccess, isAdmin, currentRole } = useRolePermissions();
  
  if (!canAccess("canAccessVentas")) {
    return <p>No tienes permisos para ver ventas</p>;
  }
  
  return <div>Contenido de ventas</div>;
};
```

### VerificaciÃ³n Condicional
```javascript
const { canAccessMultiple, canAccessAny } = useRolePermissions();

// Verificar mÃºltiples permisos
if (canAccessMultiple(["canAccessVentas", "canAccessHome"])) {
  // Usuario tiene ambos permisos
}

// Verificar al menos un permiso
if (canAccessAny(["canAccessProductos", "canAccessInventario"])) {
  // Usuario tiene al menos uno de los permisos
}
```

## Funcionalidades Especiales

### Cierre AutomÃ¡tico de Turno
- **Al cerrar sesiÃ³n**: El sistema automÃ¡ticamente cierra el turno activo
- **ImplementaciÃ³n**: Se ejecuta `cerrarTurno()` antes de limpiar la sesiÃ³n
- **UbicaciÃ³n**: `src/app/home-comandas/home/components/Sidebar.jsx`

```javascript
const handleLogout = async () => {
  // Cerrar turno antes de cerrar sesiÃ³n
  try {
    await cerrarTurno();
  } catch (error) {
    console.log("Error al cerrar turno:", error);
  }
  
  // Limpiar sesiÃ³n y redirigir
  // ...
};
```

### GestiÃ³n de Turnos
- **Todos los roles** pueden abrir y cerrar turnos
- **Persistencia**: Los turnos se guardan en localStorage
- **ValidaciÃ³n**: Los turnos se cierran automÃ¡ticamente despuÃ©s de 24 horas

## ConfiguraciÃ³n

### 1. Agregar RoleProvider
```javascript
// src/providers/AppProvider.jsx
import { RoleProvider } from "../app/context/RoleContext";

export const AppProvider = ({ children }) => {
  return (
    <QueryProvider>
      <GlobalErrorHandler>
        <AuthHandler>
          <RoleProvider>
            <TurnoProvider>
              {children}
            </TurnoProvider>
          </RoleProvider>
        </AuthHandler>
      </GlobalErrorHandler>
    </QueryProvider>
  );
};
```

### 2. Asignar Roles a Usuarios
Los roles se asignan a travÃ©s del `AuthContext`:
- **Superadmin**: Usa Firebase Auth
- **Restaurante**: Usa localStorage con campo `rol`

### 3. Personalizar Permisos
Para modificar los permisos, edita `src/app/context/RoleContext.js`:

```javascript
case "mesero":
  return {
    ...basePermissions,
    canAccessHome: true,
    canAccessVentas: true,
    // Agregar o quitar permisos segÃºn necesidad
  };
```

## PÃ¡ginas Protegidas

Las siguientes pÃ¡ginas estÃ¡n protegidas con `RoleGuard`:

- **Productos** (`canAccessProductos`) - Solo ADMIN
- **Inventario** (`canAccessInventario`) - Solo ADMIN  
- **Pagos** (`canAccessPagos`) - Solo ADMIN
- **Mesas** (`canAccessMesas`) - Solo ADMIN
- **Reportes** (`canAccessReportes`) - Solo ADMIN

## Componentes de UI

### RoleInfoCard
Muestra informaciÃ³n del rol del usuario en el dashboard:
- Nombre del rol
- DescripciÃ³n
- Permisos activos
- Colores personalizados por rol

### Indicador de Rol en Sidebar
Cuando el sidebar estÃ¡ expandido, muestra:
- Nombre del rol
- DescripciÃ³n
- Colores distintivos por tipo de rol

## Estructura de Archivos

```
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ context/
â”‚   â”‚   â”œâ”€â”€ RoleContext.js          # Contexto de roles y permisos
â”‚   â”‚   â”œâ”€â”€ AuthContext.js          # AutenticaciÃ³n existente
â”‚   â”‚   â””â”€â”€ TurnoContext.js         # GestiÃ³n de turnos
â”‚   â””â”€â”€ home-comandas/
â”‚       â”œâ”€â”€ home/
â”‚       â”‚   â”œâ”€â”€ components/
â”‚       â”‚   â”‚   â”œâ”€â”€ Sidebar.jsx     # Sidebar con permisos
â”‚       â”‚   â”‚   â””â”€â”€ RoleInfoCard.jsx # Info del rol
â”‚       â”‚   â””â”€â”€ page.jsx            # Dashboard con info de rol
â”‚       â””â”€â”€ [otras pÃ¡ginas protegidas]
â”œâ”€â”€ components/
â”‚   â””â”€â”€ RoleGuard.jsx               # ProtecciÃ³n de rutas
â”œâ”€â”€ hooks/
â”‚   â””â”€â”€ useRolePermissions.js       # Hook de permisos
â””â”€â”€ providers/
    â””â”€â”€ AppProvider.jsx             # Provider principal
```

## Beneficios del Sistema

1. **Seguridad**: Acceso controlado basado en roles
2. **UX Mejorada**: Solo se muestran opciones relevantes
3. **Mantenibilidad**: Permisos centralizados y fÃ¡ciles de modificar
4. **Escalabilidad**: FÃ¡cil agregar nuevos roles y permisos
5. **AuditorÃ­a**: Control de acceso granular y trazable

## PrÃ³ximos Pasos

- [ ] Implementar permisos mÃ¡s granulares por acciÃ³n
- [ ] Agregar logging de accesos y cambios
- [ ] Crear panel de administraciÃ³n de roles
- [ ] Implementar permisos temporales
- [ ] Agregar validaciÃ³n de permisos en el backend

---

# IntegraciÃ³n de Mercado Pago (Modelo Multi-Restaurante)

## Arquitectura Multi-Tenant

Esta aplicaciÃ³n utiliza un **modelo marketplace** para manejar pagos de mÃºltiples restaurantes:

- **Cuenta principal de Mercado Pago**: Una sola cuenta maneja todos los pagos
- **DistribuciÃ³n automÃ¡tica**: Los fondos se distribuyen automÃ¡ticamente a cada restaurante
- **ComisiÃ³n de plataforma**: 5% se retiene como comisiÃ³n de la plataforma
- **Transparencia**: Cada restaurante ve solo sus transacciones

## ConfiguraciÃ³n

### Variables de Entorno
```env
# Mercado Pago
MERCADOPAGO_ACCESS_TOKEN=APP_USR-xxxxxxxxxxxxxxxxxxxxxxxxxxxx
MERCADOPAGO_COLLECTOR_ID=123456789
NEXT_PUBLIC_BASE_URL=https://tu-dominio.com

# Firebase (ya configurado)
FIREBASE_API_KEY=xxx
FIREBASE_AUTH_DOMAIN=xxx
FIREBASE_PROJECT_ID=xxx
```

### ConfiguraciÃ³n de Mercado Pago
1. **Crear cuenta Business** en Mercado Pago
2. **Obtener Access Token** desde el panel de desarrolladores
3. **Configurar webhooks** para notificaciones de pago
4. **Obtener Collector ID** de la cuenta principal

## Flujo de Pago

### 1. Inicio del Pago
```javascript
// En CobranzaModal.jsx
const result = await processPayment(orderData, 'tarjeta');
// Redirige automÃ¡ticamente a Mercado Pago
```

### 2. Procesamiento en Mercado Pago
- Cliente completa el pago en Mercado Pago
- Se procesa con tarjeta de crÃ©dito/dÃ©bito
- Mercado Pago notifica el resultado

### 3. Webhook y DistribuciÃ³n
```javascript
// En /api/pagos/webhook/route.js
case 'approved':
  const platformFee = orderTotal * 0.05;
  const restaurantAmount = orderTotal - platformFee;
  // Distribuir fondos automÃ¡ticamente
```

### 4. ConfirmaciÃ³n
- Cliente regresa a la aplicaciÃ³n
- Se muestra confirmaciÃ³n de pago
- Mesa se marca como "pagada"

## Funcionalidades Implementadas

### âœ… Pagos con Tarjeta
- IntegraciÃ³n completa con Mercado Pago
- Soporte para tarjetas de crÃ©dito y dÃ©bito
- Procesamiento en tiempo real

### âœ… DistribuciÃ³n AutomÃ¡tica
- CÃ¡lculo automÃ¡tico de comisiones (5%)
- DistribuciÃ³n de fondos por restaurante
- Registro de transacciones en Firestore

### âœ… Historial de Pagos
- Vista de todas las transacciones del restaurante
- EstadÃ­sticas de pagos aprobados/rechazados
- Filtros por perÃ­odo

### âœ… Webhooks
- Notificaciones automÃ¡ticas de Mercado Pago
- Procesamiento de estados: approved, pending, rejected, cancelled
- ActualizaciÃ³n automÃ¡tica de mesas

## Archivos Principales

```
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ pagos/
â”‚   â”‚       â”œâ”€â”€ route.js              # Crear preferencias de pago
â”‚   â”‚       â”œâ”€â”€ webhook/route.js      # Procesar notificaciones
â”‚   â”‚       â””â”€â”€ history/route.js      # Historial de pagos
â”‚   â””â”€â”€ home-comandas/
â”‚       â””â”€â”€ pagos/
â”‚           â””â”€â”€ components/
â”‚               â””â”€â”€ PaymentHistory.jsx # Vista de historial
â”œâ”€â”€ hooks/
â”‚   â””â”€â”€ usePaymentProcessor.js        # LÃ³gica de pagos
â””â”€â”€ components/
    â””â”€â”€ PaymentStatusModal.jsx        # Modal de estado
```

## Seguridad

- **ValidaciÃ³n de webhooks**: VerificaciÃ³n de origen de Mercado Pago
- **EncriptaciÃ³n**: Tokens sensibles en variables de entorno
- **AuditorÃ­a**: Registro completo de transacciones
- **Aislamiento**: Cada restaurante ve solo sus datos

## Soporte

### Modo de Prueba (Sandbox)
```javascript
// Tarjetas de prueba
Visa: 4509 9535 6623 3704
Mastercard: 5031 4332 1540 6351
// Fecha: cualquier fecha futura
// CVV: 123
```

### Estados de Pago
- **approved**: Pago exitoso, mesa marcada como pagada
- **pending**: Pago en proceso, mesa permanece ocupada
- **rejected**: Pago rechazado, mesa permanece ocupada
- **cancelled**: Pago cancelado, mesa permanece ocupada

## ProducciÃ³n

### Checklist de ProducciÃ³n
- [ ] Cambiar a Access Token de producciÃ³n
- [ ] Configurar webhooks con URL de producciÃ³n
- [ ] Verificar configuraciÃ³n de seguridad
- [ ] Probar con montos reales
- [ ] Configurar alertas de transacciones

### Monitoreo
- Revisar logs de webhooks regularmente
- Monitorear tasa de aprobaciÃ³n de pagos
- Verificar distribuciÃ³n correcta de fondos
- Alertas para transacciones fallidas
