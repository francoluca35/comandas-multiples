# Fix: Problema de Rol "Desconocido" en Sistema de Restaurantes

## Problema Identificado

En el dashboard del sistema de restaurantes, la tarjeta "Informaci√≥n del Rol" muestra:
- **Rol**: "Rol Desconocido"
- **Descripci√≥n**: "Sin permisos definidos"
- **Permisos activos**: (vac√≠o)

Esto impide que los usuarios puedan usar la aplicaci√≥n correctamente.

## Causa del Problema

El problema estaba en el `AuthContext` que solo manejaba la autenticaci√≥n del sistema de superadmin (usando Firebase Auth), pero no manejaba la autenticaci√≥n del sistema de restaurantes (que usa localStorage).

El flujo era:
1. Usuario se loguea en sistema de restaurantes ‚Üí datos guardados en `localStorage`
2. `RoleContext` intenta obtener el rol desde `AuthContext`
3. `AuthContext` solo maneja Firebase Auth ‚Üí retorna `null`
4. `RoleContext` recibe `null` ‚Üí muestra "Rol Desconocido"

## Soluci√≥n Implementada

### 1. Modificaci√≥n del AuthContext

**Archivo**: `src/app/context/AuthContext.js`

- ‚úÖ **Detecci√≥n autom√°tica del sistema**: Detecta si est√° en `/home-master` (superadmin) o `/home-comandas` (restaurantes)
- ‚úÖ **Manejo dual de autenticaci√≥n**:
  - **Superadmin**: Usa Firebase Auth
  - **Restaurantes**: Usa localStorage
- ‚úÖ **Carga de datos de restaurante**: Lee `restauranteId`, `usuario`, `rol`, etc. desde localStorage
- ‚úÖ **Sincronizaci√≥n**: Escucha cambios en localStorage para restaurantes

### 2. Script de Debug

**Archivo**: `debug-role-state.js`

- üîç **Verificaci√≥n completa** del estado de localStorage
- üîß **Correcci√≥n autom√°tica** del `restauranteId` si no coincide
- üßπ **Limpieza de datos** de restaurante o superadmin
- üìä **Reporte detallado** del estado actual

## C√≥mo Verificar y Corregir

### 1. Ejecutar Script de Debug

```bash
npm run debug-role
```

O abrir la consola del navegador y ejecutar:

```javascript
// Ver estado actual
console.log(window.debugRoleState.localStorageData);

// Corregir restauranteId si es necesario
window.debugRoleState.corregirRestauranteId();

// Limpiar datos si hay problemas
window.debugRoleState.limpiarDatosRestaurante();
```

### 2. Verificar Datos Requeridos

Para que el rol funcione correctamente, deben existir en localStorage:

```javascript
// Datos m√≠nimos requeridos
{
  restauranteId: "deamondd",        // ID del restaurante
  usuario: "jose_luis",             // Usuario logueado
  rol: "admin",                     // Rol del usuario
  nombreCompleto: "Jos√© Luis",      // Nombre completo
  userImage: "url_imagen"           // Imagen del usuario
}
```

### 3. Flujo de Autenticaci√≥n Correcto

1. **Activaci√≥n del restaurante** (`/comandas/prelogin`)
   - Guarda datos del restaurante en localStorage
   - Genera y guarda `restauranteId`

2. **Login de usuario** (`/home-comandas/login`)
   - Guarda datos del usuario en localStorage
   - Incluye `rol`, `usuario`, `nombreCompleto`, etc.

3. **Dashboard** (`/home-comandas/home`)
   - `AuthContext` detecta sistema de restaurantes
   - Carga datos desde localStorage
   - `RoleContext` recibe el rol correcto
   - Muestra informaci√≥n del rol correctamente

## Estados Posibles del Rol

### ‚úÖ Rol Correcto
```javascript
{
  name: "Administrador",
  description: "Acceso total al sistema",
  color: "text-red-400",
  permissions: ["home", "ventas", "mesas", "productos", "pagos", "inventario", "reportes"]
}
```

### ‚ùå Rol Desconocido
```javascript
{
  name: "Rol Desconocido",
  description: "Sin permisos definidos",
  color: "text-gray-400",
  permissions: []
}
```

## Roles Soportados

- **`admin`**: Acceso total al sistema
- **`usuario`**: Acceso a dashboard y ventas
- **`mesero`**: Acceso a dashboard y ventas
- **`cocina`**: Acceso a dashboard y vista de cocina

## Comandos √ötiles

```bash
# Debug del estado del rol
npm run debug-role

# Limpiar restaurantes duplicados
npm run cleanup-restaurants

# Debug del estado de login
npm run debug-login
```

## Verificaci√≥n Final

Despu√©s de la correcci√≥n, verificar que:

1. **El rol se muestra correctamente** en la tarjeta "Informaci√≥n del Rol"
2. **Los permisos est√°n activos** seg√∫n el rol del usuario
3. **La navegaci√≥n funciona** seg√∫n los permisos del rol
4. **No hay errores en consola** relacionados con autenticaci√≥n

## Estado Actual

- ‚úÖ AuthContext modificado para manejar ambos sistemas
- ‚úÖ Script de debug disponible
- ‚úÖ Documentaci√≥n completa
- üîÑ Pendiente: Verificar en producci√≥n

## Pr√≥ximos Pasos

1. Probar el login en el sistema de restaurantes
2. Verificar que el rol se carga correctamente
3. Confirmar que los permisos funcionan seg√∫n el rol
4. Monitorear que no hay regresiones en el sistema de superadmin
